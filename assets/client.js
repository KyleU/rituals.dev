(()=>{function p(e,t){let n;t?n=t.querySelectorAll(e):n=document.querySelectorAll(e);let r=[];return n.forEach(o=>{r.push(o)}),r}function k(e,t){let n=p(e,t);switch(n.length){case 0:return;case 1:return n[0];default:console.warn(`found [${n.length}] elements with selector [${e}], wanted zero or one`)}}function s(e,t){let n=k(e,t);if(!n)throw`no element found for selector [${e}]`;return n}function z(e,t){return typeof e=="string"&&(e=s(e)),e.innerHTML=t,e}function E(e,t,n="block"){return typeof e=="string"&&(e=s(e)),e.style.display=t?n:"none",e}function c(e,t,...n){let r=document.createElement(e);for(let o in t)if(o&&t.hasOwnProperty(o)){let i=t[o];o==="dangerouslySetInnerHTML"?z(r,i.__html):i===!0?r.setAttribute(o,o):i!==!1&&i!==null&&i!==void 0&&r.setAttribute(o,i.toString())}for(let o of n)if(Array.isArray(o))o.forEach(i=>{if(o==null)throw`child array for tag [${e}] is ${o}
${r.outerHTML}`;if(i==null)throw`child for tag [${e}] is ${i}
${r.outerHTML}`;typeof i=="string"&&(i=document.createTextNode(i)),r.appendChild(i)});else{if(o==null)throw`child for tag [${e}] is ${o}
${r.outerHTML}`;o.nodeType||(o=document.createTextNode(o.toString())),r.appendChild(o)}return r}function K(){for(let e of Array.from(document.querySelectorAll(".menu-container .final")))e.scrollIntoView({block:"nearest"})}var U="mode-light",O="mode-dark";function Q(){for(let e of Array.from(document.getElementsByClassName("mode-input"))){let t=e;t.onclick=function(){switch(t.value){case"":document.body.classList.remove(U),document.body.classList.remove(O);break;case"light":document.body.classList.add(U),document.body.classList.remove(O);break;case"dark":document.body.classList.remove(U),document.body.classList.add(O);break}}}}function I(e,t,n){let r=document.getElementById("flash-container");r===null&&(r=document.createElement("div"),r.id="flash-container",document.body.insertAdjacentElement("afterbegin",r));let o=document.createElement("div");o.className="flash";let i=document.createElement("input");i.type="radio",i.style.display="none",i.id="hide-flash-"+e,o.appendChild(i);let a=document.createElement("label");a.htmlFor="hide-flash-"+e;let d=document.createElement("span");d.innerHTML="\xD7",a.appendChild(d),o.appendChild(a);let l=document.createElement("div");l.className="content flash-"+t,l.innerText=n,o.appendChild(l),r.appendChild(o),Z(o)}function V(){let e=document.getElementById("flash-container");if(e===null)return I;let t=e.querySelectorAll(".flash");if(t.length>0)for(let n of t)Z(n);return I}function Z(e){setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),500)},5e3)}function J(){for(let e of Array.from(document.getElementsByClassName("link-confirm"))){let t=e;t.onclick=function(){let n=t.dataset.message;return n&&n.length===0&&(n="Are you sure?"),confirm(n)}}}function X(){return p(".reltime").forEach(e=>{x(e.dataset.time||"",e)}),x}function ee(e){let t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds());return new Date(t).toISOString().substring(0,19).replace("T"," ")}function x(e,t){let n=(e||"").replace(/-/g,"/").replace(/[TZ]/g," ")+" UTC",r=new Date(n),o=(new Date().getTime()-r.getTime())/1e3,i=Math.floor(o/86400),a=r.getFullYear(),d=r.getMonth()+1,l=r.getDate();if(isNaN(i)||i<0||i>=31)return a.toString()+"-"+(d<10?"0"+d.toString():d.toString())+"-"+(l<10?"0"+l.toString():l.toString());let m="",f=0;return i==0?o<5?(f=1,m="just now"):o<60?(f=1,m=Math.floor(o)+" seconds ago"):o<120?(f=10,m="1 minute ago"):o<3600?(f=30,m=Math.floor(o/60)+" minutes ago"):o<7200?(f=60,m="1 hour ago"):(f=60,m=Math.floor(o/3600)+" hours ago"):i==1?(f=600,m="yesterday"):i<7?(f=600,m=i+" days ago"):(f=6e3,m=Math.ceil(i/7)+" weeks ago"),t&&(t.innerText=m,setTimeout(()=>x(e,t),f*1e3)),m}function te(){return Oe}function Oe(e,t,n,r,o){if(!e)return;let i=e.id+"-list",a=document.createElement("datalist"),d=document.createElement("option");d.value="",d.innerText="Loading...",a.appendChild(d),a.id=i,e.parentElement?.prepend(a),e.setAttribute("autocomplete","off"),e.setAttribute("list",i);let l={},m="";function f(u){let g=t;return g.includes("?")?g+"&t=json&"+n+"="+encodeURIComponent(u):g+"?t=json&"+n+"="+encodeURIComponent(u)}function N(u){let g=l[u];!g||!g.frag||(m=u,a.replaceChildren(g.frag.cloneNode(!0)))}function Fe(){let u=e.value;if(u.length===0)return;let g=f(u),D=!u||!m;if(!D){let h=l[m];h&&(D=!h.data.find(y=>u===o(y)))}if(!!D){if(l[u]&&l[u].url===g){N(u);return}fetch(g).then(h=>h.json()).then(h=>{if(!h)return;let y=Array.isArray(h)?h:[h],G=document.createDocumentFragment(),P=10;for(let w=0;w<y.length&&P>0;w++){let Y=o(y[w]),Ue=r(y[w]);if(Y){let F=document.createElement("option");F.value=Y,F.innerText=Ue,G.appendChild(F),P--}}l[u]={url:g,data:y,frag:G,complete:!1},N(u)})}}e.oninput=$e(Fe,250),console.log("managing ["+e.id+"] autocomplete")}function $e(e,t){let n=0;return function(...r){n!==0&&window.clearTimeout(n),n=window.setTimeout(function(){e(null,...r)},t)}}function ne(){document.addEventListener("keydown",e=>{e.key==="Escape"&&document.location.hash.startsWith("#modal-")&&(document.location.hash="")})}function $(e,t){return`<svg class="icon" style="width: ${t}px; height: ${t}px;"><use xlink:href="#svg-${e}"></use></svg>`}function q(e,t){return{__html:`<svg class="${t||""}" style="width: 18px; height: 18px;"><use href="#svg-${e}"></use></svg>`}}function oe(e){let t=s("input.result",e),n=s(".tags",e),r=t.value.split(",").map(i=>i.trim()).filter(i=>i!=="");E(t,!1),n.innerHTML="";for(let i of r)n.appendChild(ie(i,e));k(".add-item",e)?.remove();let o=document.createElement("div");o.className="add-item",o.innerHTML=$("plus",22),o.onclick=function(){je(n,e)},e.insertBefore(o,s(".clear",e))}function re(){for(let e of p(".tag-editor"))oe(e);return oe}function qe(e,t){return e.parentElement!==t.parentElement?null:e===t?0:e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1}var C;function ie(e,t){let n=document.createElement("div");n.className="item",n.draggable=!0,n.ondragstart=function(a){a.dataTransfer?.setDragImage(document.createElement("div"),0,0),n.classList.add("dragging"),C=n},n.ondragover=function(){let a=qe(n,C);if(!a)return;let d=a===-1?n:n.nextSibling;C.parentElement?.insertBefore(C,d),R(t)},n.ondrop=function(a){a.preventDefault()},n.ondragend=function(a){n.classList.remove("dragging"),a.preventDefault()};let r=document.createElement("div");r.innerText=e,r.className="value",r.onclick=function(){se(n)},n.appendChild(r);let o=document.createElement("input");o.className="editor",n.appendChild(o);let i=document.createElement("div");return i.innerHTML=$("times",13),i.className="close",i.onclick=function(){Re(n)},n.appendChild(i),n}function Re(e){let t=e.parentElement?.parentElement;e.remove(),t&&R(t)}function je(e,t){let n=ie("",t);e.appendChild(n),se(n)}function se(e){let t=s(".value",e),n=s(".editor",e);n.value=t.innerText;let r=function(){if(n.value===""){e.remove();return}t.innerText=n.value,E(t,!0),E(n,!1);let o=e.parentElement?.parentElement;o&&R(o)};n.onblur=r,n.onkeydown=function(o){if(o.code==="Enter")return o.preventDefault(),r(),!1},E(t,!1),E(n,!0),n.focus()}function R(e){let t=[],n=p(".item .value",e);for(let o of n)t.push(o.innerText);let r=s("input.result",e);r.value=t.join(", ")}var ae="--selected";function We(e){let t=e.parentElement?.parentElement?.querySelector("input");if(!t)throw"no associated input found";t.value="\u2205"}function j(e){e.onreset=()=>j(e);let t={},n={};for(let r of e.elements){let o=r;if(o.name.length>0)if(o.name.endsWith(ae))n[o.name]=o;else{(o.type!=="radio"||o.checked)&&(t[o.name]=o.value);let i=()=>{let a=n[o.name+ae];a&&(a.checked=t[o.name]!==o.value)};o.onchange=i,o.onkeyup=i}}}function ce(){for(let e of Array.from(document.querySelectorAll("form.editor")))j(e);return[We,j]}var Be=[];function me(){let e=document.querySelectorAll(".color-var");if(e.length>0)for(let t of Array.from(e)){let n=t,r=n.dataset.var,o=n.dataset.mode;Be.push(r),!(!r||r.length===0)&&(n.oninput=function(){_e(o,r,n.value)})}}function _e(e,t,n){let r=document.querySelector("#mockup-"+e);if(!r){console.error("can't find mockup for mode ["+e+"]");return}switch(t){case"color-foreground":b(r,".mock-main",n);break;case"color-background":L(r,".mock-main",n);break;case"color-foreground-muted":b(r,".mock-main .mock-muted",n);break;case"color-background-muted":L(r,".mock-main .mock-muted",n);break;case"color-link-foreground":b(r,".mock-main .mock-link",n);break;case"color-link-visited-foreground":b(r,".mock-main .mock-link-visited",n);break;case"color-nav-foreground":b(r,".mock-nav",n),b(r,".mock-nav .mock-link",n);break;case"color-nav-background":L(r,".mock-nav",n);break;case"color-menu-foreground":b(r,".mock-menu",n),b(r,".mock-menu .mock-link",n);break;case"color-menu-background":L(r,".mock-menu",n);break;case"color-menu-selected-foreground":b(r,".mock-menu .mock-link-selected",n);break;case"color-menu-selected-background":L(r,".mock-menu .mock-link-selected",n);break;default:console.error("invalid key ["+t+"]")}}function le(e,t,n){let r=e.querySelectorAll(t);if(r.length==0)throw"empty query selector ["+t+"]";r.forEach(o=>{n(o)})}function L(e,t,n){le(e,t,r=>r.style.backgroundColor=n)}function b(e,t,n){le(e,t,r=>r.style.color=n)}function de(){return A}var ue=!1,A=class{constructor(t,n,r,o,i){this.debug=t,this.open=n,this.recv=r,this.err=o,this.url=fe(i),this.connected=!1,this.pauseSeconds=1,this.pendingMessages=[],this.connect()}connect(){window.onbeforeunload=function(){ue=!0},this.connectTime=Date.now(),this.sock=new WebSocket(fe(this.url));let t=this;this.sock.onopen=()=>{t.connected=!0,t.pendingMessages.forEach(t.send),t.pendingMessages=[],t.debug&&console.log("WebSocket connected"),t.open()},this.sock.onmessage=n=>{let r=JSON.parse(n.data);t.debug&&console.debug("[socket]: receive",r),t.recv(r)},this.sock.onerror=n=>()=>{t.err("socket",n.type)},this.sock.onclose=()=>{if(ue)return;t.connected=!1;let n=t.connectTime?Date.now()-t.connectTime:0;0<n&&n<2e3?(t.pauseSeconds=t.pauseSeconds*2,t.debug&&console.debug(`socket closed immediately, reconnecting in ${t.pauseSeconds} seconds`),setTimeout(()=>{t.connect()},t.pauseSeconds*1e3)):(console.debug("socket closed after ["+n+"ms]"),setTimeout(()=>{t.connect()},t.pauseSeconds*500))}}disconnect(){}send(t){if(this.debug&&console.debug("out",t),!this.sock)throw"not initialized";if(this.connected){let n=JSON.stringify(t,null,2);this.sock.send(n)}else this.pendingMessages.push(t)}};function fe(e){if(e||(e="/connect"),e.indexOf("ws")==0)return e;let t=document.location,n="ws";return t.protocol==="https:"&&(n="wss"),e.indexOf("/")!=0&&(e="/"+e),n+`://${t.host}${e}`}function pe(e,t,n){return c("tr",{id:"member-"+e,class:"member","data-id":e},c("td",null,c("a",{href:"#modal-member-"+e},c("div",{class:"left",style:"padding-right: var(--padding-small);",dangerouslySetInnerHTML:q("profile")}),c("span",{class:"member-name"},t))),c("td",{class:"shrink",style:"text-align: right"},c("em",{class:"member-status"},n)),c("td",{class:"shrink online-status",title:"offline",dangerouslySetInnerHTML:q("circle","right")}))}function ge(e,t,n){let r=[["owner","Owner"],["member","Member"],["observer","Observer"]];return c("div",{id:"modal-member-"+e,"data-id":e,class:"modal modal-member",style:"display: none;"},c("a",{class:"backdrop",href:"#"}),c("div",{class:"modal-content"},c("div",{class:"modal-header"},c("a",{href:"#",class:"modal-close"},"\xD7"),c("h2",null,t)),c("div",{class:"modal-body"},c("form",{action:document.location.pathname,method:"post",class:"expanded"},c("input",{type:"hidden",name:"userID",value:e}),c("em",null,"Role"),c("br",null),c("select",{class:"input-role",name:"role"},r.map(o=>o[0]==n?c("option",{selected:"selected",value:o[0]},o[1]):c("option",{value:o[0]},o[1]))),c("hr",null),c("div",{class:"right"},c("button",{class:"member-update",type:"submit",name:"action",value:"member-update"},"Save")),c("button",{type:"submit",class:"member-remove",name:"action",value:"member-remove",onClick:"return confirm('Are you sure you wish to remove this user?');"},"Remove")))))}var H,v;function he(e){if(!e)return"System";let t=v[e];return t||"Unknown User"}function be(){return H}function ve(){Ge(),Pe(),W()}function Ge(){let e=s("#modal-self"),t=s("form",e);t.onsubmit=function(){let n=s('input[name="name"]',t),r=s('input[name="choice"]:checked',t);return T("self",{name:n.value,choice:r.value}),s("#self-name").innerText=n.value,document.location.hash="",!1}}function Pe(){let e=p(".modal-member");for(let t of e)Te(t)}function Te(e){let t=s("form",e),n=function(r){let o=s('input[name="userID"]',t).value,i=s('select[name="role"]',t).value;T(r,{userID:o,role:i});let a=s("#member-"+o);return r==="member-update"?s(".member-role",a).innerText=i:r==="member-remove"&&(a.remove(),W()),document.location.hash="",!1};s(".member-update",t).onclick=()=>n("member-update"),s(".member-remove",t).onclick=()=>confirm("Are you sure you wish to remove this user?")?n("member-remove"):!1}function W(){v={},H=s("#self-id").innerText,v[H]=s("#self-name").innerText;let e=s("#panel-members"),t=p(".member",e);for(let n of t){let r=n.dataset.id;r&&(v[r]=s(".member-name",n).innerText)}}function ye(e,t,n){if(k("#member-"+e)||e===H)return B(e,t,n);let o=s("#panel-members table tbody"),i=-1;for(let m=0;m<o.children.length;m++){let f=o.children.item(m);if(s(".member-name",f).innerText.localeCompare(t,void 0,{sensitivity:"accent"})>0){i=m;break}}let a=pe(e,t,n);i==-1?o.appendChild(a):o.insertBefore(a,o.children[i]);let d=s("#member-modals"),l=ge(e,t,n);d.appendChild(l),Te(l),v[e]=t}function B(e,t,n){if(e===H)s("#self-name").innerText=t,s("#self-role").innerText=n;else{let r=s("#member-"+e);s(".member-name",r).innerText=t,s(".member-role",r).innerText=n;let o=s("#modal-member-"+e);s('select[name="role"]',o).value=n}if(v[e]!==t){v[e]=t;let r=s("#panel-members table tbody"),o=r.children,i=[];for(let a in o)o[a].nodeType==1&&i.push(o[a]);i.sort((a,d)=>{let l=s(".member-name",a).innerText,m=s(".member-name",d).innerText;return l.localeCompare(m,void 0,{sensitivity:"accent"})}),r.replaceChildren(...i)}}function ke(e){s("#member-"+e).remove(),W()}function Ee(e,t){let n=k("#member-"+e+" .online-status");if(!n)throw"missing panel #member-"+e;n.title=t?"online":"offline";let r=t?"check-circle":"circle";n.innerHTML='<svg style="width: 18px; height: 18px;" class="right"><use xlink:href="#svg-'+r+'"></use></svg>'}function Me(e,t){let n=c("li",null),r=ee(new Date),o=c("span",{class:"nowrap reltime","data-time":r},"just now");x(r,o);let i=c("div",{class:"right"});return i.appendChild(o),n.appendChild(i),n.appendChild(c("div",null,e.content)),n.appendChild(c("div",null,c("em",null,t))),n}function xe(){let e=p(".modal.comments");for(let t of e){let n=s("form",t);n.onsubmit=function(){let r=p("input",n),o={};for(let a of r)switch(a.name){case"svc":o.svc=a.value;break;case"modelID":o.modelID=a.value;break}let i=s("textarea",n);return o.content=i.value,o.userID=be(),T("comment",o),_(o),!1}}}function _(e){let t=s("#comment-list-"+e.svc+"-"+e.modelID),n=he(e.userID),r=Me(e,n);t.appendChild(r);let o=t.childNodes.length-1,i=s("#comment-link-"+e.svc+"-"+e.modelID);i.title=o+(o==1?" comment":" comments"),i.innerHTML.indexOf("comment-dots")==-1&&(i.innerHTML='<svg style="width: 18px; height: 18px;" class="right"><use xlink:href="#svg-comment-dots"></use></svg>')}function Le(){let e=s("#modal-story--add"),t=s("form",e);t.onsubmit=function(){let n=s('input[name="title"]',t).value;return T("story-add",{title:n}),!1}}function He(){console.log("TODO: storyAdd")}function we(e,t){switch(t.cmd){case"error":return Ye(t.param.message);case"comment":return _(t.param);case"online-update":return Ee(t.param.userID,t.param.connected);case"member-add":return ye(t.param.userID,t.param.name,t.param.role);case"member-update":return B(t.param.userID,t.param.name,t.param.role);case"member-remove":return ke(t.param)}switch(e){case"estimate":switch(t.cmd){case"story-add":return He()}}}function Ye(e){I("error","error",e)}function Ie(){console.log("team!")}function Ce(){console.log("sprint!")}function Ae(){console.log("standup!")}function Se(){console.log("retro!")}var Ne,M,S;function ze(){console.log("[socket]: open")}function Ke(e){let t=document.getElementById("socket-list");if(t){let n=document.createElement("pre");n.innerText=JSON.stringify(e,null,2),t.append(n)}we(M,e)}function Qe(e){console.log("[socket error]: "+e)}function Ve(e,t){switch(M=e,S=t,xe(),ve(),M){case"team":Ie();break;case"sprint":Ce();break;case"estimate":Le();break;case"standup":Ae();break;case"retro":Se();break}Ne=new A(!0,ze,Ke,Qe,"/"+M+"/"+S+"/connect"),console.log("loaded ["+M+"] workspace ["+S+"]")}function T(e,t){Ne.send({channel:M+":"+S,cmd:e,param:t})}function De(){window.initWorkspace=Ve}function Ze(){let[e,t]=ce();window.rituals={relativeTime:X(),autocomplete:te(),setSiblingToNull:e,initForm:t,flash:V(),tags:re(),Socket:de()},K(),Q(),J(),ne(),me(),window.JSX=c,De()}document.addEventListener("DOMContentLoaded",Ze);})();
//# sourceMappingURL=client.js.map
