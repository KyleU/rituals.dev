(()=>{function p(e,t){let n;t?n=t.querySelectorAll(e):n=document.querySelectorAll(e);let r=[];return n.forEach(o=>{r.push(o)}),r}function k(e,t){let n=p(e,t);switch(n.length){case 0:return;case 1:return n[0];default:console.warn(`found [${n.length}] elements with selector [${e}], wanted zero or one`)}}function s(e,t){let n=k(e,t);if(!n)throw`no element found for selector [${e}]`;return n}function Y(e,t){return typeof e=="string"&&(e=s(e)),e.innerHTML=t,e}function M(e,t,n="block"){return typeof e=="string"&&(e=s(e)),e.style.display=t?n:"none",e}function a(e,t,...n){let r=document.createElement(e);for(let o in t)if(o&&t.hasOwnProperty(o)){let i=t[o];o==="dangerouslySetInnerHTML"?Y(r,i.__html):i===!0?r.setAttribute(o,o):i!==!1&&i!==null&&i!==void 0&&r.setAttribute(o,i.toString())}for(let o of n)if(Array.isArray(o))o.forEach(i=>{if(o==null)throw`child array for tag [${e}] is ${o}
${r.outerHTML}`;if(i==null)throw`child for tag [${e}] is ${i}
${r.outerHTML}`;typeof i=="string"&&(i=document.createTextNode(i)),r.appendChild(i)});else{if(o==null)throw`child for tag [${e}] is ${o}
${r.outerHTML}`;o.nodeType||(o=document.createTextNode(o.toString())),r.appendChild(o)}return r}function z(){for(let e of Array.from(document.querySelectorAll(".menu-container .final")))e.scrollIntoView({block:"nearest"})}var U="mode-light",$="mode-dark";function K(){for(let e of Array.from(document.getElementsByClassName("mode-input"))){let t=e;t.onclick=function(){switch(t.value){case"":document.body.classList.remove(U),document.body.classList.remove($);break;case"light":document.body.classList.add(U),document.body.classList.remove($);break;case"dark":document.body.classList.remove(U),document.body.classList.add($);break}}}}function C(e,t,n){let r=document.getElementById("flash-container");r===null&&(r=document.createElement("div"),r.id="flash-container",document.body.insertAdjacentElement("afterbegin",r));let o=document.createElement("div");o.className="flash";let i=document.createElement("input");i.type="radio",i.style.display="none",i.id="hide-flash-"+e,o.appendChild(i);let c=document.createElement("label");c.htmlFor="hide-flash-"+e;let l=document.createElement("span");l.innerHTML="\xD7",c.appendChild(l),o.appendChild(c);let d=document.createElement("div");d.className="content flash-"+t,d.innerText=n,o.appendChild(d),r.appendChild(o),Z(o)}function Q(){let e=document.getElementById("flash-container");if(e===null)return C;let t=e.querySelectorAll(".flash");if(t.length>0)for(let n of t)Z(n);return C}function Z(e){setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),500)},5e3)}function J(){for(let e of Array.from(document.getElementsByClassName("link-confirm"))){let t=e;t.onclick=function(){let n=t.dataset.message;return n&&n.length===0&&(n="Are you sure?"),confirm(n)}}}function X(){return p(".reltime").forEach(e=>{E(e.dataset.time||"",e)}),E}function ee(e){let t=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds());return new Date(t).toISOString().substring(0,19).replace("T"," ")}function E(e,t){let n=(e||"").replace(/-/g,"/").replace(/[TZ]/g," ")+" UTC",r=new Date(n),o=(new Date().getTime()-r.getTime())/1e3,i=Math.floor(o/86400),c=r.getFullYear(),l=r.getMonth()+1,d=r.getDate();if(isNaN(i)||i<0||i>=31)return c.toString()+"-"+(l<10?"0"+l.toString():l.toString())+"-"+(d<10?"0"+d.toString():d.toString());let m="",f=0;return i==0?o<5?(f=1,m="just now"):o<60?(f=1,m=Math.floor(o)+" seconds ago"):o<120?(f=10,m="1 minute ago"):o<3600?(f=30,m=Math.floor(o/60)+" minutes ago"):o<7200?(f=60,m="1 hour ago"):(f=60,m=Math.floor(o/3600)+" hours ago"):i==1?(f=600,m="yesterday"):i<7?(f=600,m=i+" days ago"):(f=6e3,m=Math.ceil(i/7)+" weeks ago"),t&&(t.innerText=m,setTimeout(()=>E(e,t),f*1e3)),m}function te(){return _e}function _e(e,t,n,r,o){if(!e)return;let i=e.id+"-list",c=document.createElement("datalist"),l=document.createElement("option");l.value="",l.innerText="Loading...",c.appendChild(l),c.id=i,e.parentElement?.prepend(c),e.setAttribute("autocomplete","off"),e.setAttribute("list",i);let d={},m="";function f(u){let g=t;return g.includes("?")?g+"&t=json&"+n+"="+encodeURIComponent(u):g+"?t=json&"+n+"="+encodeURIComponent(u)}function N(u){let g=d[u];!g||!g.frag||(m=u,c.replaceChildren(g.frag.cloneNode(!0)))}function Be(){let u=e.value;if(u.length===0)return;let g=f(u),O=!u||!m;if(!O){let h=d[m];h&&(O=!h.data.find(y=>u===o(y)))}if(!!O){if(d[u]&&d[u].url===g){N(u);return}fetch(g).then(h=>h.json()).then(h=>{if(!h)return;let y=Array.isArray(h)?h:[h],V=document.createDocumentFragment(),G=10;for(let I=0;I<y.length&&G>0;I++){let P=o(y[I]),We=r(y[I]);if(P){let F=document.createElement("option");F.value=P,F.innerText=We,V.appendChild(F),G--}}d[u]={url:g,data:y,frag:V,complete:!1},N(u)})}}e.oninput=Ve(Be,250),console.log("managing ["+e.id+"] autocomplete")}function Ve(e,t){let n=0;return function(...r){n!==0&&window.clearTimeout(n),n=window.setTimeout(function(){e(null,...r)},t)}}function ne(){document.addEventListener("keydown",e=>{e.key==="Escape"&&document.location.hash.startsWith("#modal-")&&(document.location.hash="")})}function q(e,t){return`<svg class="icon" style="width: ${t}px; height: ${t}px;"><use xlink:href="#svg-${e}"></use></svg>`}function L(e,t){return{__html:`<svg class="${t||""}" style="width: 18px; height: 18px;"><use href="#svg-${e}"></use></svg>`}}function oe(e){let t=s("input.result",e),n=s(".tags",e),r=t.value.split(",").map(i=>i.trim()).filter(i=>i!=="");M(t,!1),n.innerHTML="";for(let i of r)n.appendChild(ie(i,e));k(".add-item",e)?.remove();let o=document.createElement("div");o.className="add-item",o.innerHTML=q("plus",22),o.onclick=function(){Ye(n,e)},e.insertBefore(o,s(".clear",e))}function re(){for(let e of p(".tag-editor"))oe(e);return oe}function Ge(e,t){return e.parentElement!==t.parentElement?null:e===t?0:e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1}var A;function ie(e,t){let n=document.createElement("div");n.className="item",n.draggable=!0,n.ondragstart=function(c){c.dataTransfer?.setDragImage(document.createElement("div"),0,0),n.classList.add("dragging"),A=n},n.ondragover=function(){let c=Ge(n,A);if(!c)return;let l=c===-1?n:n.nextSibling;A.parentElement?.insertBefore(A,l),R(t)},n.ondrop=function(c){c.preventDefault()},n.ondragend=function(c){n.classList.remove("dragging"),c.preventDefault()};let r=document.createElement("div");r.innerText=e,r.className="value",r.onclick=function(){se(n)},n.appendChild(r);let o=document.createElement("input");o.className="editor",n.appendChild(o);let i=document.createElement("div");return i.innerHTML=q("times",13),i.className="close",i.onclick=function(){Pe(n)},n.appendChild(i),n}function Pe(e){let t=e.parentElement?.parentElement;e.remove(),t&&R(t)}function Ye(e,t){let n=ie("",t);e.appendChild(n),se(n)}function se(e){let t=s(".value",e),n=s(".editor",e);n.value=t.innerText;let r=function(){if(n.value===""){e.remove();return}t.innerText=n.value,M(t,!0),M(n,!1);let o=e.parentElement?.parentElement;o&&R(o)};n.onblur=r,n.onkeydown=function(o){if(o.code==="Enter")return o.preventDefault(),r(),!1},M(t,!1),M(n,!0),n.focus()}function R(e){let t=[],n=p(".item .value",e);for(let o of n)t.push(o.innerText);let r=s("input.result",e);r.value=t.join(", ")}var ae="--selected";function ze(e){let t=e.parentElement?.parentElement?.querySelector("input");if(!t)throw"no associated input found";t.value="\u2205"}function j(e){e.onreset=()=>j(e);let t={},n={};for(let r of e.elements){let o=r;if(o.name.length>0)if(o.name.endsWith(ae))n[o.name]=o;else{(o.type!=="radio"||o.checked)&&(t[o.name]=o.value);let i=()=>{let c=n[o.name+ae];c&&(c.checked=t[o.name]!==o.value)};o.onchange=i,o.onkeyup=i}}}function ce(){for(let e of Array.from(document.querySelectorAll("form.editor")))j(e);return[ze,j]}var Ke=[];function me(){let e=document.querySelectorAll(".color-var");if(e.length>0)for(let t of Array.from(e)){let n=t,r=n.dataset.var,o=n.dataset.mode;Ke.push(r),!(!r||r.length===0)&&(n.oninput=function(){Qe(o,r,n.value)})}}function Qe(e,t,n){let r=document.querySelector("#mockup-"+e);if(!r){console.error("can't find mockup for mode ["+e+"]");return}switch(t){case"color-foreground":v(r,".mock-main",n);break;case"color-background":H(r,".mock-main",n);break;case"color-foreground-muted":v(r,".mock-main .mock-muted",n);break;case"color-background-muted":H(r,".mock-main .mock-muted",n);break;case"color-link-foreground":v(r,".mock-main .mock-link",n);break;case"color-link-visited-foreground":v(r,".mock-main .mock-link-visited",n);break;case"color-nav-foreground":v(r,".mock-nav",n),v(r,".mock-nav .mock-link",n);break;case"color-nav-background":H(r,".mock-nav",n);break;case"color-menu-foreground":v(r,".mock-menu",n),v(r,".mock-menu .mock-link",n);break;case"color-menu-background":H(r,".mock-menu",n);break;case"color-menu-selected-foreground":v(r,".mock-menu .mock-link-selected",n);break;case"color-menu-selected-background":H(r,".mock-menu .mock-link-selected",n);break;default:console.error("invalid key ["+t+"]")}}function le(e,t,n){let r=e.querySelectorAll(t);if(r.length==0)throw"empty query selector ["+t+"]";r.forEach(o=>n(o))}function H(e,t,n){le(e,t,r=>r.style.backgroundColor=n)}function v(e,t,n){le(e,t,r=>r.style.color=n)}function de(){return S}var ue=!1,S=class{constructor(t,n,r,o,i){this.debug=t,this.open=n,this.recv=r,this.err=o,this.url=fe(i),this.connected=!1,this.pauseSeconds=1,this.pendingMessages=[],this.connect()}connect(){window.onbeforeunload=function(){ue=!0},this.connectTime=Date.now(),this.sock=new WebSocket(fe(this.url));let t=this;this.sock.onopen=()=>{t.connected=!0,t.pendingMessages.forEach(t.send),t.pendingMessages=[],t.debug&&console.log("WebSocket connected"),t.open()},this.sock.onmessage=n=>{let r=JSON.parse(n.data);t.debug&&console.debug("[socket]: receive",r),t.recv(r)},this.sock.onerror=n=>()=>{t.err("socket",n.type)},this.sock.onclose=()=>{if(ue)return;t.connected=!1;let n=t.connectTime?Date.now()-t.connectTime:0;0<n&&n<2e3?(t.pauseSeconds=t.pauseSeconds*2,t.debug&&console.debug(`socket closed immediately, reconnecting in ${t.pauseSeconds} seconds`),setTimeout(()=>{t.connect()},t.pauseSeconds*1e3)):(console.debug("socket closed after ["+n+"ms]"),setTimeout(()=>{t.connect()},t.pauseSeconds*500))}}disconnect(){}send(t){if(this.debug&&console.debug("out",t),!this.sock)throw"not initialized";if(this.connected){let n=JSON.stringify(t,null,2);this.sock.send(n)}else this.pendingMessages.push(t)}};function fe(e){if(e||(e="/connect"),e.indexOf("ws")==0)return e;let t=document.location,n="ws";return t.protocol==="https:"&&(n="wss"),e.indexOf("/")!=0&&(e="/"+e),n+`://${t.host}${e}`}function pe(e,t,n){return a("tr",{id:"member-"+e,class:"member","data-id":e},a("td",null,a("a",{href:"#modal-member-"+e},a("div",{class:"left",style:"padding-right: var(--padding-small);",dangerouslySetInnerHTML:L("profile")}),a("span",{class:"member-name"},t))),a("td",{class:"shrink",style:"text-align: right"},a("em",{class:"member-status"},n)),a("td",{class:"shrink online-status",title:"offline",dangerouslySetInnerHTML:L("circle","right")}))}function ge(e,t,n){let r=[["owner","Owner"],["member","Member"],["observer","Observer"]];return a("div",{id:"modal-member-"+e,"data-id":e,class:"modal modal-member",style:"display: none;"},a("a",{class:"backdrop",href:"#"}),a("div",{class:"modal-content"},a("div",{class:"modal-header"},a("a",{href:"#",class:"modal-close"},"\xD7"),a("h2",null,t)),a("div",{class:"modal-body"},a("form",{action:document.location.pathname,method:"post",class:"expanded"},a("input",{type:"hidden",name:"userID",value:e}),a("em",null,"Role"),a("br",null),a("select",{class:"input-role",name:"role"},r.map(o=>o[0]==n?a("option",{selected:"selected",value:o[0]},o[1]):a("option",{value:o[0]},o[1]))),a("hr",null),a("div",{class:"right"},a("button",{class:"member-update",type:"submit",name:"action",value:"member-update"},"Save")),a("button",{type:"submit",class:"member-remove",name:"action",value:"member-remove",onClick:"return confirm('Are you sure you wish to remove this user?');"},"Remove")))))}var w,b;function he(e){if(!e)return"System";let t=b[e];return t||"Unknown User"}function ve(){return w}function be(){Ze(),Je(),B()}function Ze(){let e=s("#modal-self"),t=s("form",e);t.onsubmit=function(){let n=s('input[name="name"]',t),r=s('input[name="choice"]:checked',t);return T("self",{name:n.value,choice:r.value}),s("#self-name").innerText=n.value,document.location.hash="",!1}}function Je(){let e=p(".modal-member");for(let t of e)Te(t)}function Te(e){let t=s("form",e),n=function(r){let o=s('input[name="userID"]',t).value,i=s('select[name="role"]',t).value;T(r,{userID:o,role:i});let c=s("#member-"+o);return r==="member-update"?s(".member-role",c).innerText=i:r==="member-remove"&&(c.remove(),B()),document.location.hash="",!1};s(".member-update",t).onclick=()=>n("member-update"),s(".member-remove",t).onclick=()=>confirm("Are you sure you wish to remove this user?")?n("member-remove"):!1}function B(){b={},w=s("#self-id").innerText,b[w]=s("#self-name").innerText;let e=s("#panel-members"),t=p(".member",e);for(let n of t){let r=n.dataset.id;r&&(b[r]=s(".member-name",n).innerText)}}function ye(e,t,n){if(k("#member-"+e)||e===w)return W(e,t,n);let o=s("#panel-members table tbody"),i=-1;for(let m=0;m<o.children.length;m++){let f=o.children.item(m);if(s(".member-name",f).innerText.localeCompare(t,void 0,{sensitivity:"accent"})>0){i=m;break}}let c=pe(e,t,n);i==-1?o.appendChild(c):o.insertBefore(c,o.children[i]);let l=s("#member-modals"),d=ge(e,t,n);l.appendChild(d),Te(d),b[e]=t}function W(e,t,n){if(e===w)s("#self-name").innerText=t,s("#self-role").innerText=n;else{let r=s("#member-"+e);s(".member-name",r).innerText=t,s(".member-role",r).innerText=n;let o=s("#modal-member-"+e);s('select[name="role"]',o).value=n}if(b[e]!==t){b[e]=t;let r=s("#panel-members table tbody"),o=r.children,i=[];for(let c in o)o[c].nodeType==1&&i.push(o[c]);i.sort((c,l)=>{let d=s(".member-name",c).innerText,m=s(".member-name",l).innerText;return d.localeCompare(m,void 0,{sensitivity:"accent"})}),r.replaceChildren(...i)}}function ke(e){s("#member-"+e).remove(),B()}function Me(e,t){let n=k("#member-"+e+" .online-status");if(!n)throw"missing panel #member-"+e;n.title=t?"online":"offline";let r=t?"check-circle":"circle";n.innerHTML='<svg style="width: 18px; height: 18px;" class="right"><use xlink:href="#svg-'+r+'"></use></svg>'}function xe(e,t){let n=a("li",null),r=ee(new Date),o=a("span",{class:"nowrap reltime","data-time":r},"just now");E(r,o);let i=a("div",{class:"right"});return i.appendChild(o),n.appendChild(i),n.appendChild(a("div",null,e.content)),n.appendChild(a("div",null,a("em",null,t))),n}function Ee(){let e=p(".modal.comments");for(let t of e){let n=s("form",t);n.onsubmit=function(){let r=p("input",n),o={};for(let c of r)switch(c.name){case"svc":o.svc=c.value;break;case"modelID":o.modelID=c.value;break}let i=s("textarea",n);return o.content=i.value,o.userID=ve(),T("comment",o),_(o),!1}}}function _(e){let t=s("#comment-list-"+e.svc+"-"+e.modelID),n=he(e.userID),r=xe(e,n);t.appendChild(r);let o=t.childNodes.length-1,i=s("#comment-link-"+e.svc+"-"+e.modelID);i.title=o+(o==1?" comment":" comments"),i.innerHTML.indexOf("comment-dots")==-1&&(i.innerHTML='<svg style="width: 18px; height: 18px;" class="right"><use xlink:href="#svg-comment-dots"></use></svg>')}function Le(){console.log("team!")}function He(e){switch(e.cmd){default:throw"invalid team command ["+e.cmd+"]"}}function we(){console.log("sprint!")}function Ie(e){switch(e.cmd){default:throw"invalid sprint command ["+e.cmd+"]"}}function Ce(e){let t="comment-link-"+e.estimateID,n="#modal-"+e.estimateID+"-comments";return a("tr",{class:"story-row",id:"story-row-{%s s.ID.String() %}","data-idx":"s.Idx"},a("td",null,a("a",{href:"#modal-story-"+e.id,class:"story-title"},e.title)),a("td",null,e.status),a("td",null,e.finalVote?e.finalVote:"-"),a("td",null,a("a",{id:t,href:n,title:"0 comments",dangerouslySetInnerHTML:L("comment-alt")})))}function Ae(){let e=s("#modal-story--add"),t=s("form",e);t.onsubmit=function(){let n=s('input[name="title"]',t).value;return T("story-add",{title:n}),!1}}function Se(e){console.log("TODO: storyAdd");let t=s("#panel-detail table tbody"),n=-1;for(let o=0;o<t.children.length;o++){let i=t.children.item(o),c=s(".story-title",i).innerText,l=i.dataset.index;if(l&&parseInt(l,10)>=e.idx){n=o;break}if(c.localeCompare(e.title,void 0,{sensitivity:"accent"})>=0){n=o;break}}let r=Ce(e);n==-1?t.appendChild(r):t.insertBefore(r,t.children[n])}function De(){Ae()}function Ne(e){switch(e.cmd){case"story-add":return Se(e.param);default:throw"invalid estimate command ["+e.cmd+"]"}}function Oe(){console.log("standup!")}function Fe(e){switch(e.cmd){default:throw"invalid standup command ["+e.cmd+"]"}}function Ue(){console.log("retro!")}function $e(e){switch(e.cmd){default:throw"invalid retro command ["+e.cmd+"]"}}function qe(e,t){switch(t.cmd){case"error":return Xe(t.param.message);case"comment":return _(t.param);case"online-update":return Me(t.param.userID,t.param.connected);case"member-add":return ye(t.param.userID,t.param.name,t.param.role);case"member-update":return W(t.param.userID,t.param.name,t.param.role);case"member-remove":return ke(t.param)}switch(e){case"team":return He(t);case"sprint":return Ie(t);case"estimate":return Ne(t);case"standup":return Fe(t);case"retro":return $e(t);default:throw"invalid service ["+e+"]"}}function Xe(e){C("error","error",e)}var Re,x,D;function et(){console.log("[socket]: open")}function tt(e){let t=document.getElementById("socket-list");if(t){let n=document.createElement("pre");n.innerText=JSON.stringify(e,null,2),t.append(n)}qe(x,e)}function nt(e){console.log("[socket error]: "+e)}function ot(e,t){switch(x=e,D=t,Ee(),be(),x){case"team":Le();break;case"sprint":we();break;case"estimate":De();break;case"standup":Oe();break;case"retro":Ue();break}Re=new S(!0,et,tt,nt,"/"+x+"/"+D+"/connect"),console.log("loaded ["+x+"] workspace ["+D+"]")}function T(e,t){Re.send({channel:x+":"+D,cmd:e,param:t})}function je(){window.initWorkspace=ot}function rt(){let[e,t]=ce();window.rituals={relativeTime:X(),autocomplete:te(),setSiblingToNull:e,initForm:t,flash:Q(),tags:re(),Socket:de()},z(),K(),J(),ne(),me(),window.JSX=a,je()}document.addEventListener("DOMContentLoaded",rt);})();
//# sourceMappingURL=client.js.map
