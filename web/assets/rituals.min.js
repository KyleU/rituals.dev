var estimate;
(function(b){function e(a){b.cache.detail=a;util.req("#model-choices-input").value=a.choices.join(", ");rituals.setDetail(a)}function a(a){var f=b.cache.stories;f=f.filter(function(f){return f.id!==a.id});f.push(a);f=f.sort(function(a,f){return a.idx>f.idx?1:-1});story.setStories(f)}var d=function(){function a(){this.stories=[];this.votes=[]}a.prototype.activeVotes=function(){var a=this;return void 0===this.activeStory?(console.log("!!!"),[]):this.votes.filter(function(f){return f.storyID==a.activeStory})};
return a}();b.cache=new d;b.onEstimateMessage=function(c,f){switch(c){case command.server.error:rituals.onError(services.estimate,f);break;case command.server.sessionJoined:rituals.onSessionJoin(f);e(f.session);story.setStories(f.stories);story.setVotes(f.votes);break;case command.server.sessionUpdate:e(f);break;case command.server.storyUpdate:a(f);break;case command.server.storyStatusChange:story.onStoryStatusChange(f);break;case command.server.voteUpdate:story.onVoteUpdate(f);break;default:console.warn("unhandled command ["+
c+"] for estimate")}};b.onSubmitEstimateSession=function(){var a=util.req("#model-title-input").value,f=util.req("#model-choices-input").value;socket.send({svc:services.estimate,cmd:command.client.updateSession,param:{title:a,choices:f}})}})(estimate||(estimate={}));var events;
(function(b){b.openModal=function(b,a){switch(b){case "self":var d=util.req("#self-name-input");d.value=util.req("#member-self .member-name").innerText;setTimeout(function(){return d.focus()},250);break;case "session":var c=util.req("#model-title-input");c.value=util.req("#model-title").innerText;setTimeout(function(){return c.focus()},250);break;case "invite":break;case "member":system.cache.activeMember=a;member.viewActiveMember();break;case "add-story":var f=util.req("#story-title-input");f.value=
"";setTimeout(function(){return f.focus()},250);break;case "story":estimate.cache.activeStory=a;story.viewActiveStory();break;default:console.debug("unhandled modal ["+b+"]")}UIkit.modal("#modal-"+b).show();return!1}})(events||(events={}));var system;(function(b){var e=function(){return function(){this.currentID=this.currentService="";this.connectTime=0;this.members=[];this.online=[]}}();b.cache=new e})(system||(system={}));var services;
(function(b){b.system="system";b.estimate="estimate";b.standup="standup";b.retro="retro"})(services||(services={}));var command;
(function(b){b.client={error:"error",ping:"ping",connect:"connect",updateProfile:"update-profile",updateSession:"update-session",addStory:"add-story",updateStory:"update-story",setStoryStatus:"set-story-status",submitVote:"submit-vote"};b.server={error:"error",pong:"pong",sessionJoined:"session-joined",sessionUpdate:"session-update",memberUpdate:"member-update",onlineUpdate:"online-update",storyUpdate:"story-update",storyStatusChange:"story-status-change",voteUpdate:"vote-update"}})(command||(command=
{}));function JSX(b,e){var a=document.createElement(b),d;for(d in e)if(d&&e.hasOwnProperty(d)){var c=e[d];!0===c?a.setAttribute(d,d):!1!==c&&null!==c&&void 0!==c&&a.setAttribute(d,c.toString())}for(d=2;d<arguments.length;d++)if(c=arguments[d],Array.isArray(c))c.forEach(function(f){a.appendChild(f)});else{if(null===c.nodeType||void 0===c.nodeType)c=document.createTextNode(c.toString());a.appendChild(c)}return a}var member;
(function(b){function e(a){return void 0===system.cache.profile?!1:a.userID===system.cache.profile.userID}function a(){var a=system.cache.members.filter(e);1===a.length?(util.req("#member-self .member-name").innerText=a[0].name,util.req("#self-name-input").value=a[0].name,util.req("#member-self .member-role").innerText=a[0].role.key):0===a.length?console.warn("self not found among members"):console.warn("multiple self entries found among members");a=system.cache.members.filter(function(a){return!e(a)});
var c=util.req("#member-detail");c.innerHTML="";c.appendChild(b.renderMembers(a));d()}function d(){for(var a=0,c=system.cache.members;a<c.length;a++){var d=c[a],b=util.els("#member-"+d.userID+" .online-indicator");1===b.length&&(-1===system.cache.online.indexOf(d.userID)?b[0].classList.add("offline"):b[0].classList.remove("offline"))}}function c(){if(void 0===system.cache.activeMember)console.warn("no active member");else{var a=system.cache.members.filter(function(a){return a.userID===system.cache.activeMember});
if(1!==a.length)console.log("cannot load active member ["+system.cache.activeMember+"]");else return a[0]}}b.setMembers=a;b.onMemberUpdate=function(c){e(c)&&UIkit.modal("#modal-self").hide();var d=system.cache.members;d=d.filter(function(a){return a.userID!==c.userID});d.push(c);d=d.sort(function(a,c){return a.name>c.name?1:-1});system.cache.members=d;a();estimate.cache.activeStory&&story.viewVotes()};b.onOnlineUpdate=function(a){a.connected?-1===system.cache.online.indexOf(a.userID)&&system.cache.online.push(a.userID):
system.cache.online=system.cache.online.filter(function(c){return c!==a.userID});d()};b.onSubmitSelf=function(){var a=util.req("#self-name-input").value,c=util.req("#self-name-choice-global").checked?"global":"local";socket.send({svc:services.system,cmd:command.client.updateProfile,param:{name:a,choice:c}})};b.viewActiveMember=function(){var a=c();void 0!==a&&(util.req("#member-modal-name").innerText=a.name,util.req("#member-modal-role").innerText=a.role.key)}})(member||(member={}));var retro;
(function(b){var e=new (function(){return function(){}}());b.onRetroMessage=function(a,d){switch(a){case command.server.error:rituals.onError(services.retro,d);break;case command.server.sessionJoined:rituals.onSessionJoin(d);a=d.session;e.detail=a;rituals.setDetail(a);break;case command.server.sessionUpdate:e.detail=d;rituals.setDetail(d);break;default:console.warn("unhandled command ["+a+"] for retro")}};b.onSubmitRetroSession=function(){var a=util.req("#model-title-input").value;socket.send({svc:services.retro,
cmd:command.client.updateSession,param:{title:a}})}})(retro||(retro={}));var rituals;
(function(b){function e(a,d){console.warn(a+": "+d);var c=d.lastIndexOf(":");-1<c&&(d=d.substr(c+1));UIkit.notification(a+" error: "+d,{status:"danger",pos:"top-right"})}b.onSocketMessage=function(a){console.log("message received");console.log(a);switch(a.svc){case services.system:var d=a.cmd;a=a.param;switch(d){case command.server.error:e("system",a);break;case command.server.memberUpdate:member.onMemberUpdate(a);break;case command.server.onlineUpdate:member.onOnlineUpdate(a);break;default:console.warn("unhandled system message for command ["+
d+"]")}break;case services.estimate:estimate.onEstimateMessage(a.cmd,a.param);break;case services.standup:standup.onStandupMessage(a.cmd,a.param);break;case services.retro:retro.onRetroMessage(a.cmd,a.param);break;default:console.warn("unhandled message for service ["+a.svc+"]")}};b.setDetail=function(a){system.cache.session=a;util.req("#model-title").innerText=a.title;util.req("#model-title-input").value=a.title;var d=util.els("#navbar .uk-navbar-item");0<d.length&&(d[d.length-1].innerText=a.title);
UIkit.modal("#modal-session").hide()};b.onError=e;b.onSessionJoin=function(a){system.cache.session=a.session;system.cache.profile=a.profile;system.cache.members=a.members;system.cache.online=a.online;member.setMembers()};b.init=function(a,d){window.onbeforeunload=function(){socket.setAppUnloading()};socket.socketConnect(a,d)}})(rituals||(rituals={}));var socket;
(function(b){function e(){var a=document.location,c="ws";"https:"===a.protocol&&(c="wss");return c+"://"+a.host+"/s"}function a(a,b){system.cache.currentService=a;system.cache.currentID=b;system.cache.connectTime=Date.now();f=new WebSocket(e());f.onopen=function(){console.debug("socket connected");d({svc:a,cmd:command.client.connect,param:b})};f.onmessage=function(a){a=JSON.parse(a.data);rituals.onSocketMessage(a)};f.onerror=function(a){rituals.onError("socket",a.type)};f.onclose=function(){c()}}
function d(a){console.log("sending message");console.log(a);f.send(JSON.stringify(a))}function c(){function c(c){1===c?console.warn("socket closed, reconnecting in a second"):console.warn("socket closed, reconnecting in "+c+" seconds");setTimeout(function(){a(system.cache.currentService,system.cache.currentID)},1E3*c)}g||(2E3>Date.now()-system.cache.connectTime?c(6):c(1))}var f,g=!1;b.setAppUnloading=function(){g=!0};b.socketConnect=a;b.send=d})(socket||(socket={}));var standup;
(function(b){var e=new (function(){return function(){}}());b.onStandupMessage=function(a,d){switch(a){case command.server.error:rituals.onError(services.standup,d);break;case command.server.sessionJoined:rituals.onSessionJoin(d);a=d.session;e.detail=a;rituals.setDetail(a);break;case command.server.sessionUpdate:e.detail=d;rituals.setDetail(d);break;default:console.warn("unhandled command ["+a+"] for standup")}};b.onSubmitStandupSession=function(){var a=util.req("#model-title-input").value;socket.send({svc:services.standup,
cmd:command.client.updateSession,param:{title:a}})}})(standup||(standup={}));var story;
(function(b){function e(){if(void 0===estimate.cache.activeStory)console.warn("no active story");else{var a=estimate.cache.stories.filter(function(a){return a.id===estimate.cache.activeStory});if(1!==a.length)console.warn("cannot load active story ["+estimate.cache.activeStory+"]");else return a[0]}}function a(a){switch(a){case "active":d();break;case "complete":d()}for(var c=0,b=util.els(".story-status-section");c<b.length;c++){var e=b[c];e.id.substr(e.id.lastIndexOf("-")+1)===a?e.classList.add("active"):
e.classList.remove("active")}}function d(){var a=estimate.cache.activeVotes(),d=a.filter(function(a){return a.userID===system.cache.profile.userID}).pop(),e=util.req("#story-vote-members");e.innerHTML="";e.appendChild(b.renderVoteMembers(system.cache.members,a));a=util.req("#story-vote-choices");a.innerHTML="";a.appendChild(b.renderVoteChoices(estimate.cache.detail.choices,null===d||void 0===d?void 0:d.choice))}b.setStories=function(a){estimate.cache.stories=a;var c=util.req("#story-detail");c.innerHTML=
"";c.appendChild(b.renderStories(a));UIkit.modal("#modal-add-story").hide()};b.setVotes=function(a){estimate.cache.votes=a;estimate.cache.activeStory&&d()};b.onSubmitStory=function(){var a=util.req("#story-title-input").value;socket.send({svc:services.estimate,cmd:command.client.addStory,param:{title:a}});return!1};b.viewActiveStory=function(){var c=e();void 0===c?console.log("no active story"):(util.req("#story-title").innerText=c.title,a(c.status.key))};b.onVoteUpdate=function(a){var c=estimate.cache.votes;
c=c.filter(function(c){return c.userID!=a.userID||c.storyID!=a.storyID});c.push(a);estimate.cache.votes=c;a.storyID===estimate.cache.activeStory&&d()};b.viewVotes=function(){d()};b.requestStoryStatus=function(a){var c=e();void 0===c?console.log("no active story"):socket.send({svc:services.estimate,cmd:command.client.setStoryStatus,param:{storyID:c.id,status:a}})};b.onStoryStatusChange=function(c){util.req("#story-"+c.storyID+" .story-status").innerText=c.status.key;a(c.status.key)};b.onSubmitVote=
function(a){socket.send({svc:services.estimate,cmd:command.client.submitVote,param:{storyID:estimate.cache.activeStory,choice:a}})}})(story||(story={}));var util;(function(b){b.els=function(b,a){return UIkit.util.$$(b,a)};b.req=function(e,a){a=b.els(e,a);0===a.length&&console.error("no element found for selector ["+e+"]");return a[0]}})(util||(util={}));
(function(b){b.renderMembers=function(b){return 0===b.length?JSX("div",null,JSX("button",{"class":"uk-button uk-button-default",onclick:"events.openModal('invite');",type:"button"},"Invite Members")):JSX("ul",{"class":"uk-list uk-list-divider"},b.map(function(a){var d={id:"member-"+a.userID};var c=system.cache.profile;a=void 0===c?JSX("div",{"class":"uk-margin-bottom"},"error"):JSX("div",null,JSX("div",{title:"user is offline","class":"right uk-article-meta online-indicator"},"offline"),JSX("a",{"class":c.linkColor+
"-fg",href:"",onclick:"return events.openModal('member', '"+a.userID+"');"},a.name));return JSX("li",d,a)}))}})(member||(member={}));
(function(b){function e(a,d){return JSX("div",{"class":"vote-member",title:a.name+" has "+(d?"voted":"not voted")},JSX("div",null,JSX("span",{"data-uk-icon":"icon: "+(d?"check":"minus")+"; ratio: 1.6"})),a.name)}b.renderStories=function(a){return 0===a.length?JSX("div",null,JSX("button",{"class":"uk-button uk-button-default",onclick:"events.openModal('add-story');",type:"button"},"Add Story")):JSX("ul",{"class":"uk-list uk-list-divider"},a.map(function(a){var c=system.cache.profile;a=void 0===c?JSX("li",
null,"profile error"):JSX("li",{id:"story-"+a.id},JSX("div",{"class":"right uk-article-meta story-status"},a.status.key),JSX("a",{"class":c.linkColor+"-fg",href:"",onclick:"return events.openModal('story', '"+a.id+"');"},a.title));return a}))};b.renderVoteMembers=function(a,b){return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-around"},a.map(function(a){return e(a,0<b.filter(function(c){return c.userID==a.userID}).length)}))};b.renderVoteChoices=function(a,b){return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-center"},
a.map(function(a){return JSX("div",{"class":"vote-choice uk-border-circle uk-box-shadow-hover-medium"+(a===b?" active "+system.cache.profile.linkColor+"-border":""),onclick:"story.onSubmitVote('"+a+"');"},a)}))}})(story||(story={}));
