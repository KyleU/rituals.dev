var estimate;
(function(b){function e(a){b.cache.detail=a;util.req("#model-choices-input").value=a.choices.join(", ");rituals.setDetail(a)}function a(a){var d=b.cache.stories;d=d.filter(function(d){return d.id!==a.id});d.push(a);d=d.sort(function(a,d){return a.idx>d.idx?1:-1});story.setStories(d)}var c=function(){function a(){this.stories=[];this.votes=[]}a.prototype.activeVotes=function(){var a=this;return void 0===this.activeStory?[]:this.votes.filter(function(d){return d.storyID==a.activeStory})};return a}();
b.cache=new c;b.onEstimateMessage=function(b,d){switch(b){case command.server.error:rituals.onError(services.estimate,d);break;case command.server.sessionJoined:rituals.onSessionJoin(d);e(d.session);story.setStories(d.stories);story.setVotes(d.votes);break;case command.server.sessionUpdate:e(d);break;case command.server.storyUpdate:a(d);break;case command.server.storyStatusChange:story.onStoryStatusChange(d);break;case command.server.voteUpdate:story.onVoteUpdate(d);break;default:console.warn("unhandled command ["+
b+"] for estimate")}};b.onSubmitEstimateSession=function(){var a=util.req("#model-title-input").value,d=util.req("#model-choices-input").value;socket.send({svc:services.estimate,cmd:command.client.updateSession,param:{title:a,choices:d}})}})(estimate||(estimate={}));var events;
(function(b){b.openModal=function(b,a){switch(b){case "self":var c=util.req("#self-name-input");c.value=util.req("#member-self .member-name").innerText;setTimeout(function(){return c.focus()},250);break;case "session":var f=util.req("#model-title-input");f.value=util.req("#model-title").innerText;setTimeout(function(){return f.focus()},250);break;case "invite":break;case "member":system.cache.activeMember=a;member.viewActiveMember();break;case "add-story":var d=util.req("#story-title-input");d.value=
"";setTimeout(function(){return d.focus()},250);break;case "story":estimate.cache.activeStory=a;story.viewActiveStory();break;default:console.debug("unhandled modal ["+b+"]")}UIkit.modal("#modal-"+b).show();return!1}})(events||(events={}));var system;(function(b){var e=function(){return function(){this.currentID=this.currentService="";this.connectTime=0;this.members=[];this.online=[]}}();b.cache=new e})(system||(system={}));var services;
(function(b){b.system="system";b.estimate="estimate";b.standup="standup";b.retro="retro"})(services||(services={}));var command;
(function(b){b.client={error:"error",ping:"ping",connect:"connect",updateProfile:"update-profile",updateSession:"update-session",addStory:"add-story",updateStory:"update-story",setStoryStatus:"set-story-status",submitVote:"submit-vote"};b.server={error:"error",pong:"pong",sessionJoined:"session-joined",sessionUpdate:"session-update",memberUpdate:"member-update",onlineUpdate:"online-update",storyUpdate:"story-update",storyStatusChange:"story-status-change",voteUpdate:"vote-update"}})(command||(command=
{}));function JSX(b,e){var a=document.createElement(b),c;for(c in e)if(c&&e.hasOwnProperty(c)){var f=e[c];!0===f?a.setAttribute(c,c):!1!==f&&null!==f&&void 0!==f&&a.setAttribute(c,f.toString())}for(c=2;c<arguments.length;c++)if(f=arguments[c],Array.isArray(f))f.forEach(function(d){a.appendChild(d)});else{if(null===f.nodeType||void 0===f.nodeType)f=document.createTextNode(f.toString());a.appendChild(f)}return a}var member;
(function(b){function e(a){return void 0===system.cache.profile?!1:a.userID===system.cache.profile.userID}function a(){var a=system.cache.members.filter(e);1===a.length?(util.req("#member-self .member-name").innerText=a[0].name,util.req("#self-name-input").value=a[0].name,util.req("#member-self .member-role").innerText=a[0].role.key):0===a.length?console.warn("self not found among members"):console.warn("multiple self entries found among members");a=system.cache.members.filter(function(a){return!e(a)});
util.setContent("#member-detail",b.renderMembers(a));c()}function c(){for(var a=0,b=system.cache.members;a<b.length;a++){var c=b[a],g=util.els("#member-"+c.userID+" .online-indicator");1===g.length&&(-1===system.cache.online.indexOf(c.userID)?g[0].classList.add("offline"):g[0].classList.remove("offline"))}}function f(){if(void 0===system.cache.activeMember)console.warn("no active member");else{var a=system.cache.members.filter(function(a){return a.userID===system.cache.activeMember});if(1!==a.length)console.log("cannot load active member ["+
system.cache.activeMember+"]");else return a[0]}}b.setMembers=a;b.onMemberUpdate=function(b){e(b)&&UIkit.modal("#modal-self").hide();var c=system.cache.members;c=c.filter(function(a){return a.userID!==b.userID});c.push(b);c=c.sort(function(a,b){return a.name>b.name?1:-1});system.cache.members=c;a();estimate.cache.activeStory&&story.viewVotes()};b.onOnlineUpdate=function(a){a.connected?-1===system.cache.online.indexOf(a.userID)&&system.cache.online.push(a.userID):system.cache.online=system.cache.online.filter(function(b){return b!==
a.userID});c()};b.onSubmitSelf=function(){var a=util.req("#self-name-input").value,b=util.req("#self-name-choice-global").checked?"global":"local";socket.send({svc:services.system,cmd:command.client.updateProfile,param:{name:a,choice:b}})};b.viewActiveMember=function(){var a=f();void 0!==a&&(util.req("#member-modal-name").innerText=a.name,util.req("#member-modal-role").innerText=a.role.key)}})(member||(member={}));var retro;
(function(b){var e=new (function(){return function(){}}());b.onRetroMessage=function(a,b){switch(a){case command.server.error:rituals.onError(services.retro,b);break;case command.server.sessionJoined:rituals.onSessionJoin(b);a=b.session;e.detail=a;rituals.setDetail(a);break;case command.server.sessionUpdate:e.detail=b;rituals.setDetail(b);break;default:console.warn("unhandled command ["+a+"] for retro")}};b.onSubmitRetroSession=function(){var a=util.req("#model-title-input").value;socket.send({svc:services.retro,
cmd:command.client.updateSession,param:{title:a}})}})(retro||(retro={}));var rituals;
(function(b){function e(a,b){console.warn(a+": "+b);var c=b.lastIndexOf(":");-1<c&&(b=b.substr(c+1));UIkit.notification(a+" error: "+b,{status:"danger",pos:"top-right"})}b.onSocketMessage=function(a){console.log("message received");console.log(a);switch(a.svc){case services.system:var b=a.cmd;a=a.param;switch(b){case command.server.error:e("system",a);break;case command.server.memberUpdate:member.onMemberUpdate(a);break;case command.server.onlineUpdate:member.onOnlineUpdate(a);break;default:console.warn("unhandled system message for command ["+
b+"]")}break;case services.estimate:estimate.onEstimateMessage(a.cmd,a.param);break;case services.standup:standup.onStandupMessage(a.cmd,a.param);break;case services.retro:retro.onRetroMessage(a.cmd,a.param);break;default:console.warn("unhandled message for service ["+a.svc+"]")}};b.setDetail=function(a){system.cache.session=a;util.req("#model-title").innerText=a.title;util.req("#model-title-input").value=a.title;var b=util.els("#navbar .uk-navbar-item");0<b.length&&(b[b.length-1].innerText=a.title);
UIkit.modal("#modal-session").hide()};b.onError=e;b.onSessionJoin=function(a){system.cache.session=a.session;system.cache.profile=a.profile;system.cache.members=a.members;system.cache.online=a.online;member.setMembers()};b.init=function(a,b){window.onbeforeunload=function(){socket.setAppUnloading()};socket.socketConnect(a,b)}})(rituals||(rituals={}));var socket;
(function(b){function e(){var a=document.location,b="ws";"https:"===a.protocol&&(b="wss");return b+"://"+a.host+"/s"}function a(a,b){system.cache.currentService=a;system.cache.currentID=b;system.cache.connectTime=Date.now();d=new WebSocket(e());d.onopen=function(){console.debug("socket connected");c({svc:a,cmd:command.client.connect,param:b})};d.onmessage=function(a){a=JSON.parse(a.data);rituals.onSocketMessage(a)};d.onerror=function(a){rituals.onError("socket",a.type)};d.onclose=function(){f()}}
function c(a){console.log("sending message");console.log(a);d.send(JSON.stringify(a))}function f(){function b(b){1===b?console.warn("socket closed, reconnecting in a second"):console.warn("socket closed, reconnecting in "+b+" seconds");setTimeout(function(){a(system.cache.currentService,system.cache.currentID)},1E3*b)}h||(2E3>Date.now()-system.cache.connectTime?b(6):b(1))}var d,h=!1;b.setAppUnloading=function(){h=!0};b.socketConnect=a;b.send=c})(socket||(socket={}));var standup;
(function(b){var e=new (function(){return function(){}}());b.onStandupMessage=function(a,b){switch(a){case command.server.error:rituals.onError(services.standup,b);break;case command.server.sessionJoined:rituals.onSessionJoin(b);a=b.session;e.detail=a;rituals.setDetail(a);break;case command.server.sessionUpdate:e.detail=b;rituals.setDetail(b);break;default:console.warn("unhandled command ["+a+"] for standup")}};b.onSubmitStandupSession=function(){var a=util.req("#model-title-input").value;socket.send({svc:services.standup,
cmd:command.client.updateSession,param:{title:a}})}})(standup||(standup={}));var story;
(function(b){function e(){var a=0;estimate.cache.stories.filter(function(a){return"complete"===a.status.key}).map(function(a){return a.finalVote}).filter(function(a){return 0<a.length}).map(function(a){return parseFloat(a)}).filter(function(a){return!isNaN(a)}).forEach(function(b){return a+=b});var c=util.opt("#story-total"),f=util.req("#story-list");null!==c&&f.removeChild(c);0<a&&f.appendChild(b.renderTotal(a))}function a(){if(void 0!==estimate.cache.activeStory){var a=estimate.cache.stories.filter(function(a){return a.id===
estimate.cache.activeStory});if(1!==a.length)console.warn("cannot load active story ["+estimate.cache.activeStory+"]");else return a[0]}}function c(a){function b(a,b){a.id.substr(a.id.lastIndexOf("-")+1)===b?a.classList.add("active"):a.classList.remove("active")}for(var c=0,d=util.els(".story-status-body");c<d.length;c++){var g=d[c];b(g,a)}c=0;for(d=util.els(".story-status-actions");c<d.length;c++)g=d[c],b(g,a);g="TODO";switch(a){case "pending":g="Story";break;case "active":g="Voting";break;case "complete":g=
"Results"}util.req("#story-status").innerText=g;f()}function f(){var b=a();if(void 0!==b){var c=estimate.cache.activeVotes(),f=c.filter(function(a){return a.userID===system.cache.profile.userID}).pop();"active"==b.status.key&&d(c,f);"complete"==b.status.key&&h(c)}}function d(a,c){util.setContent("#story-vote-members",b.renderVoteMembers(system.cache.members,a));util.setContent("#story-vote-choices",b.renderVoteChoices(estimate.cache.detail.choices,null===c||void 0===c?void 0:c.choice))}function h(a){util.setContent("#story-vote-results",
b.renderVoteResults(system.cache.members,a));util.setContent("#story-vote-summary",b.renderVoteSummary(a))}function k(a,c,d,f){null!==d&&"complete"==d.status.key&&0<d.finalVote.length&&(c=d.finalVote);util.setContent("#story-"+a+" .story-status",b.renderStatus(c));f&&e()}b.setStories=function(a){estimate.cache.stories=a;util.setContent("#story-detail",b.renderStories(a));a.forEach(function(a){return k(a.id,a.status.key,a,!1)});e();UIkit.modal("#modal-add-story").hide()};b.setVotes=function(a){estimate.cache.votes=
a;f()};b.onSubmitStory=function(){var a=util.req("#story-title-input").value;socket.send({svc:services.estimate,cmd:command.client.addStory,param:{title:a}});return!1};b.viewActiveStory=function(){var b=a();void 0===b?console.log("no active story"):(util.req("#story-title").innerText=b.title,c(b.status.key))};b.onVoteUpdate=function(a){var b=estimate.cache.votes;b=b.filter(function(b){return b.userID!=a.userID||b.storyID!=a.storyID});b.push(a);estimate.cache.votes=b;a.storyID===estimate.cache.activeStory&&
f()};b.viewVotes=f;b.requestStoryStatus=function(b){var c=a();void 0===c?console.log("no active story"):socket.send({svc:services.estimate,cmd:command.client.setStoryStatus,param:{storyID:c.id,status:b}})};b.onStoryStatusChange=function(a){var b=null;estimate.cache.stories.forEach(function(c){c.id==a.storyID&&(b=c,c.finalVote=a.finalVote,c.status=a.status)});k(a.storyID,a.status.key,b,!0);a.storyID===estimate.cache.activeStory&&c(a.status.key)};b.onSubmitVote=function(a){socket.send({svc:services.estimate,
cmd:command.client.submitVote,param:{storyID:estimate.cache.activeStory,choice:a}})};b.getVoteResults=function(a){a=a.map(function(a){a=parseFloat(a.choice);return isNaN(a)?-1:a}).filter(function(a){return-1!==a}).sort();var b=a.length,c=Math.min.apply(Math,a),d=Math.max.apply(Math,a),f=a.reduce(function(a,b){return a+b},0),e=a.reduce(function(a,b){var c=a.numMapping[b]=(a.numMapping[b]||0)+1;c>a.greatestFreq&&(a.greatestFreq=c,a.mode=b);return a},{mode:null,greatestFreq:-Infinity,numMapping:{}}).mode;
return{count:b,min:c,max:d,sum:f,mean:0==b?0:f/b,median:0==b?0:a[Math.floor(a.length/2)],mode:0==b?0:e}}})(story||(story={}));var util;(function(b){b.els=function(b,a){return UIkit.util.$$(b,a)};b.opt=function(e,a){e=b.els(e,a);return 0===e.length?null:e[0]};b.req=function(e,a){a=b.opt(e,a);null===a&&console.error("no element found for selector ["+e+"]");return a};b.setContent=function(e,a){e=b.req(e);e.innerHTML="";e.appendChild(a)}})(util||(util={}));
(function(b){b.renderMembers=function(b){return 0===b.length?JSX("div",null,JSX("button",{"class":"uk-button uk-button-default",onclick:"events.openModal('invite');",type:"button"},"Invite Members")):JSX("ul",{"class":"uk-list uk-list-divider"},b.map(function(a){var b={id:"member-"+a.userID};var f=system.cache.profile;a=void 0===f?JSX("div",{"class":"uk-margin-bottom"},"error"):JSX("div",null,JSX("div",{title:"user is offline","class":"right uk-article-meta online-indicator"},"offline"),JSX("a",{"class":f.linkColor+
"-fg",href:"",onclick:"return events.openModal('member', '"+a.userID+"');"},a.name));return JSX("li",b,a)}))}})(member||(member={}));
(function(b){function e(a,b){return JSX("div",{"class":"vote-member",title:a.name+" has "+(b?"voted":"not voted")},JSX("div",null,JSX("span",{"data-uk-icon":"icon: "+(b?"check":"minus")+"; ratio: 1.6"})),a.name)}function a(a,b){return void 0===b?JSX("div",{"class":"vote-result"},JSX("div",null,JSX("span",{"class":"uk-border-circle"},JSX("span",{"data-uk-icon":"icon: minus; ratio: 1.6"})))," ",a.name):JSX("div",{"class":"vote-result"},JSX("div",null,JSX("span",{"class":"uk-border-circle"},b))," ",
a.name)}b.renderStories=function(a){return 0===a.length?JSX("div",null,JSX("button",{"class":"uk-button uk-button-default",onclick:"events.openModal('add-story');",type:"button"},"Add Story")):JSX("ul",{id:"story-list","class":"uk-list uk-list-divider"},a.map(function(a){var b=system.cache.profile;a=void 0===b?JSX("li",null,"profile error"):JSX("li",{id:"story-"+a.id},JSX("div",{"class":"right uk-article-meta story-status"},a.status.key),JSX("a",{"class":b.linkColor+"-fg",href:"",onclick:"return events.openModal('story', '"+
a.id+"');"},a.title));return a}))};b.renderVoteMembers=function(a,b){return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-around"},a.map(function(a){return e(a,0<b.filter(function(b){return b.userID==a.userID}).length)}))};b.renderVoteChoices=function(a,b){return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-center"},a.map(function(a){return JSX("div",{"class":"vote-choice uk-border-circle uk-box-shadow-hover-medium"+(a===b?" active "+system.cache.profile.linkColor+"-border":""),onclick:"story.onSubmitVote('"+
a+"');"},a)}))};b.renderVoteResults=function(b,f){return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-around"},b.map(function(b){var c=f.filter(function(a){return a.userID==b.userID});return a(b,0<c.length?c[0].choice:void 0)}))};b.renderVoteSummary=function(a){function c(a){return a.toString().substr(0,4)}var d,e=b.getVoteResults(a);return JSX("div",{"class":"uk-flex uk-flex-wrap uk-flex-center result-container"},JSX("div",{"class":"result"},JSX("div",{"class":"secondary uk-border-circle"},c(e.count),
" / ",c(a.length))," ",JSX("div",null,"votes counted")),JSX("div",{"class":"result"},JSX("div",{"class":"secondary uk-border-circle"},c(e.min),"-",c(e.max))," ",JSX("div",null,"vote range")),JSX("div",{"class":"result mean-result"},JSX("div",{"class":"mean uk-border-circle "+(null===(d=system.cache.profile)||void 0===d?void 0:d.linkColor)+"-border"},c(e.mean))," ",JSX("div",null,"average")),JSX("div",{"class":"result"},JSX("div",{"class":"secondary uk-border-circle"},c(e.median))," ",JSX("div",null,
"median")),JSX("div",{"class":"result"},JSX("div",{"class":"secondary uk-border-circle"},c(e.mode))," ",JSX("div",null,"mode")))};b.renderStatus=function(a){switch(a){case "pending":return JSX("span",null,a);case "active":return JSX("span",null,a);default:return JSX("span",{"class":"vote-badge uk-border-rounded"},a)}};b.renderTotal=function(a){return JSX("li",{id:"story-total"},JSX("div",{"class":"right uk-article-meta"},JSX("span",{"class":"vote-badge uk-border-rounded"},a))," Total")}})(story||
(story={}));
