{% import (
  "github.com/kyleu/rituals/app/action"
  "github.com/kyleu/rituals/app/controller/cutil"
  "github.com/kyleu/rituals/app/enum"
  "github.com/kyleu/rituals/app/estimate/story"
  "github.com/kyleu/rituals/app/estimate/story/vote"
  "github.com/kyleu/rituals/app/workspace"
  "github.com/kyleu/rituals/views/components"
) %}

{% func EstimateWorkspaceStories(w *workspace.FullEstimate, ps *cutil.PageState) %}
  <table class="mt expanded">
    <tbody>
      {%- for _, s := range w.Stories -%}
      <tr>
        <td><a href="#modal-story-{%s s.ID.String() %}">{%s s.TitleString() %}</a></td>
        <td class="shrink">
          {%- switch s.Status -%}
          {%- default -%}
          {%s string(s.Status) %}: {%s s.FinalVoteSafe() %}
          {%- endswitch -%}
        </td>
      </tr>
      {%- endfor -%}
    </tbody>
  </table>
  {%- for _, s := range w.Stories -%}
  {%- if ps.Profile.ID == s.UserID -%}
  {%= EstimateWorkspaceStoryModalEdit(s, ps) %}
  {%- endif -%}
  {%= EstimateWorkspaceStoryModal(w, s, ps) %}
  {%- endfor -%}
{% endfunc %}

{% func EstimateWorkspaceStoryModalAdd() %}
  <div id="modal-story--add" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>Add Story</h2>
      </div>
      <div class="modal-body">
        <form action="#" method="post">
          <input type="hidden" name="action" value="{%s string(action.ActStoryAdd) %}" />
          {%= components.FormVerticalInput("title", "Title", "", 5, "Story title") %}
          <div class="mt">
            <a href="#"><button type="button">Cancel</button></a>
            <button type="submit">Add Story</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryModal(w *workspace.FullEstimate, s *story.Story, ps *cutil.PageState) %}
  <div id="modal-story-{%s s.ID.String() %}" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>Story</h2>
      </div>
      <div class="modal-body">
        <h2 class="billboard">{%s s.TitleString() %}</h2>
        {%= EstimateWorkspaceStoryPanelNew(w, s, ps) %}
        {%= EstimateWorkspaceStoryPanelActive(w, s, ps) %}
        {%= EstimateWorkspaceStoryPanelComplete(w, s, ps) %}
      </div>
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryPanelNew(w *workspace.FullEstimate, s *story.Story, ps *cutil.PageState) %}
  <div class="mt" {% if s.Status != enum.SessionStatusNew %} style="display: none;"{% endif %}>
    <form action="" method="post">
      <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
      <input type="hidden" name="action" value="{%s string(action.ActStoryStatus) %}" />
      <input type="hidden" name="status" value="{%s string(enum.SessionStatusActive) %}" />
      {%- if ps.Profile.ID == s.UserID -%}
      <div>Your story is available to <a href="#modal-story-{%s s.ID.String() %}-edit">edit</a> and ready to <button type="submit" class="button-link">start voting</button></div>
      {%- else -%}
      {%- if mem := w.Members.Get(s.EstimateID, s.UserID); mem == nil -%}
      <div>This story is ready to start voting</div>
      {%- else -%}
      <div>This story was created by <a href="{%s mem.PublicWebPath(w.Estimate.Slug) %}">{%s mem.Name %}</a> and is ready to <button type="submit" class="button-link">start voting</button></div>
      {%- endif -%}
      {%- endif -%}
    </form>
    <hr />
    <div class="mt">
      <form action="" method="post">
        <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
        <input type="hidden" name="action" value="{%s string(action.ActStoryStatus) %}" />
        <input type="hidden" name="status" value="{%s string(enum.SessionStatusActive) %}" />
        <div class="right"><button type="submit">Start Voting</button></div>
      </form>
      <form action="" method="post" onsubmit="return confirm('Are you sure you want to delete this story?')">
        <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
        <input type="hidden" name="action" value="{%s string(action.ActStoryRemove) %}" />
        <div><button type="submit">Delete Story</button></div>
      </form>
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryPanelActive(w *workspace.FullEstimate, s *story.Story, ps *cutil.PageState) %}
  <div class="mt" {% if s.Status != enum.SessionStatusActive %} style="display: none;"{% endif %}>
    <h4>Members</h4>
    <div class="story-members">
      {%- for _, m := range w.Members -%}
      {%- code v := w.Votes.Get(s.ID, m.UserID) -%}
      <div class="member">
        {%- if v == nil -%}
        <div>-</div>
        {%- else -%}
        <div>{%s v.Choice %}</div>
        {%- endif -%}
        {%s m.Name %}
      </div>
      {%- endfor -%}
    </div>
    <hr />
    <h4>Choices</h4>
    <form action="" method="post">
      <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
      <input type="hidden" name="action" value="{%s string(action.ActVote) %}" />
      <div class="story-votes">
        {%- code selfVote := w.Votes.Get(s.ID, ps.Profile.ID) -%}
        {%- for _, c := range w.Estimate.Choices -%}
        <div class="vote">
          <label>
            {%- if selfVote != nil && selfVote.Choice == c -%}
            <input type="radio" name="vote" value="{%s c %}" checked="checked" />
            {%- else -%}
            <input type="radio" name="vote" value="{%s c %}" />
            {%- endif -%}
            <div class="vote-choice">{%s c %}</div>
          </label>
        </div>
        {%- endfor -%}
      </div>
      <div class="mt">
        <div class="right"><button type="submit">Submit vote</button></div>
      </div>
      <div class="clear"></div>
    </form>
    <hr />
    <div class="mt">
      <form action="" method="post">
        <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
        <input type="hidden" name="action" value="{%s string(action.ActStoryStatus) %}" />
        <input type="hidden" name="status" value="{%s string(enum.SessionStatusComplete) %}" />
        <div class="right"><button type="submit">Finish Voting</button></div>
      </form>
      <form action="" method="post">
        <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
        <input type="hidden" name="action" value="{%s string(action.ActStoryStatus) %}" />
        <input type="hidden" name="status" value="{%s string(enum.SessionStatusNew) %}" />
        <div><button type="submit">Reopen</button></div>
      </form>
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryPanelComplete(w *workspace.FullEstimate, s *story.Story, ps *cutil.PageState) %}
  <div class="mt" {% if s.Status != enum.SessionStatusComplete %} style="display: none;"{% endif %}>
    <div class="mt story-results">
      {%- if s.Status == enum.SessionStatusComplete -%}
      <div class="vote-results">
        {%- for _, m := range w.Members -%}
        <div class="vote-result">
          {%- if v := w.Votes.Get(s.ID, m.UserID); v == nil -%}
          <div class="number" title="user did not vote">-</div>
          {%- else -%}
          <div class="number">{%s v.Choice %}</div>
          {%- endif -%}
          {%v m.Name %}
        </div>
        {%- endfor -%}
      </div>
      {%- else -%}
      <em>Voting in progress...</em>
      {%- endif -%}
    </div>
    <hr />
    <div class="mt">
      {%- if s.Status == enum.SessionStatusComplete -%}
      {%= EstimateWorkspaceStoryResults(w.Votes.GetByStoryIDs(s.ID), ps) %}
      {%- else -%}
      <em>Voting is still active</em>
      {%- endif -%}
    </div>
    <hr />
    <div class="mt">
      <div class="right">
        <a href="#"><button type="button">Close</button></a>
      </div>
      <form action="" method="post">
        <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
        <input type="hidden" name="action" value="{%s string(action.ActStoryStatus) %}" />
        <input type="hidden" name="status" value="{%s string(enum.SessionStatusActive) %}" />
        <div><button type="submit">Reopen</button></div>
      </form>
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryResults(v vote.Votes, ps *cutil.PageState) %}
  {%- code r := v.Results() -%}
  <div class="vote-calculations">
    <div class="vote-calculation" title="portion of votes that were able to be parsed as numbers">
      <div class="value">{%d r.Count %}/{%d len(v) %}</div>
      Count
    </div>
    <div class="vote-calculation" title="the minimum and maximum vote recorded">
      <div class="value">{%f r.Min %}-{%f r.Max %}</div>
      Range
    </div>
    <div class="vote-calculation" title="mean average of all votes">
      <div class="value">{%f r.Mean %}</div>
      Average
    </div>
    <div class="vote-calculation" title="median value from collected votes">
      <div class="value">{%f r.Median %}</div>
      Median
    </div>
    <div class="vote-calculation" title="mode value(s) from collected votes">
      <div class="value">{%s r.ModeString() %}</div>
      Mode
    </div>
  </div>
{% endfunc %}

{% func EstimateWorkspaceStoryModalEdit(s *story.Story, ps *cutil.PageState) %}
  <div id="modal-story-{%s s.ID.String() %}-edit" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>Edit Story</h2>
      </div>
      <div class="modal-body">
        <form action="#" method="post">
          <input type="hidden" name="storyID" value="{%s s.ID.String() %}" />
          {%= components.FormVerticalInput("title", "Title", s.Title, 5, "Story title") %}
          <div class="mt">
            <div class="right"><button type="submit" name="action" value="{%s string(action.ActStoryRemove) %}" onclick="return confirm('Are you sure you want to delete this story?');">Delete</button></div>
            <button type="submit" name="action" value="{%s string(action.ActStoryUpdate) %}">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endfunc %}
