{% import (
  "github.com/kyleu/rituals/app/action"
  "github.com/kyleu/rituals/app/controller/cutil"
  "github.com/kyleu/rituals/app/standup/report"
  "github.com/kyleu/rituals/app/util"
  "github.com/kyleu/rituals/app/workspace"
  "github.com/kyleu/rituals/views/components"
) %}

{% func StandupWorkspaceReports(w *workspace.FullStandup, ps *cutil.PageState) %}
  <ul class="accordion">
    {%- for _, g := range w.Reports.Grouped() -%}
    <li>
      <input id="accordion-{%s util.TimeToYMD(&g.Day) %}" type="checkbox" hidden checked="checked" />
      <label for="accordion-{%s util.TimeToYMD(&g.Day) %}">{%= components.ExpandCollapse(3, ps) %} {%s util.TimeToYMD(&g.Day) %}</label>
      <div class="bd">
        {%- for _, r := range g.Reports -%}
        <a class="report" href="#modal-report-{%s r.ID.String() %}" style="text-decoration: none; color: var(--color-foreground);">
          <div>
            {%- code
              uname := "Former Guest"
              curr := w.Members.Get(w.Standup.ID, r.UserID)
              if curr != nil {
                uname = curr.Name
              }
            -%}
            <h4>{%s uname %}</h4>
            <div>{%s= r.HTML %}</div>
          </div>
        </a>
        {%- endfor -%}
      </div>
    </li>
    {%- endfor -%}
  </ul>
  {%- for _, r := range w.Reports -%}
  {%- if ps.Profile.ID == r.UserID -%}
  {%= StandupWorkspaceReportModalEdit(r) %}
  {%- else -%}
  {%= StandupWorkspaceReportModalView(r) %}
  {%- endif -%}
  {%- endfor -%}
{% endfunc %}

{% func StandupWorkspaceReportModalAdd() %}
  <div id="modal-report--add" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>New Report</h2>
      </div>
      <div class="modal-body">
        <form action="#" method="post">
          <input type="hidden" name="action" value="{%s string(action.ActReportAdd) %}" />
          <table class="mt expanded">
            <tbody>
            {%= components.FormVerticalInputTimestampDay("day", "Day", util.TimeToday(), 5, ) %}
            {%= components.FormVerticalTextarea("content", "Content", 8, "", 5, "HTML and Markdown supported") %}
            <tr><td colspan="2"><button type="submit">Add Report</button></td></tr>
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </div>
{% endfunc %}

{% func StandupWorkspaceReportModalEdit(r *report.Report) %}
  <div id="modal-report-{%s r.ID.String() %}" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>{%s r.TitleString() %}</h2>
      </div>
      <div class="modal-body">
        <form action="#" method="post">
          <input type="hidden" name="reportID" value="{%s r.ID.String() %}" />
          <table class="mt expanded">
            <tbody>
            {%= components.FormVerticalInputTimestampDay("day", "Day", &r.Day, 5, ) %}
            {%= components.FormVerticalTextarea("content", "Content", 8, r.Content, 5, "HTML and Markdown supported") %}
            <tr><td colspan="2">
              <div class="right"><button type="submit" name="action" value="{%s string(action.ActReportRemove) %}" onclick="return confirm('Are you sure you want to delete this report?');">Delete</button></div>
              <button type="submit" name="action" value="{%s string(action.ActReportUpdate) %}">Save Changes</button>
            </td></tr>
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </div>
{% endfunc %}

{% func StandupWorkspaceReportModalView(r *report.Report) %}
  <div id="modal-report-{%s r.ID.String() %}" class="modal" style="display: none;">
    <a class="backdrop" href="#"></a>
    <div class="modal-content">
      <div class="modal-header">
        <a href="#" class="modal-close">×</a>
        <h2>{%s r.TitleString() %}</h2>
      </div>
      <div class="modal-body">
        {%s= r.HTML %}
      </div>
    </div>
  </div>
{% endfunc %}
